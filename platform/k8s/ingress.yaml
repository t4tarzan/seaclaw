---
# SeaClaw Platform — Ingress with TLS (Let's Encrypt via cert-manager)
#
# Prerequisites:
#   1. Install cert-manager:
#      kubectl apply -f https://github.com/cert-manager/cert-manager/releases/latest/download/cert-manager.yaml
#
#   2. Create a ClusterIssuer (done once per cluster):
#      kubectl apply -f - <<EOF
#      apiVersion: cert-manager.io/v1
#      kind: ClusterIssuer
#      metadata:
#        name: letsencrypt-prod
#      spec:
#        acme:
#          server: https://acme-v02.api.letsencrypt.org/directory
#          email: YOUR_EMAIL_HERE
#          privateKeySecretRef:
#            name: letsencrypt-prod-key
#          solvers:
#            - http01:
#                ingress:
#                  class: traefik   # use 'nginx' if using nginx-ingress
#      EOF
#
#   3. Edit PLATFORM_DOMAIN below (or pass via envsubst)
#   4. kubectl apply -f k8s/ingress.yaml
#
# Usage with envsubst:
#   PLATFORM_DOMAIN=platform.yourdomain.com \
#   LETSENCRYPT_EMAIL=admin@yourdomain.com \
#   envsubst < k8s/ingress.yaml | kubectl apply -f -

---
# TLS certificate (cert-manager issues automatically)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: seaclaw-tls
  namespace: seaclaw-platform
spec:
  secretName: seaclaw-tls-secret
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
    - ${PLATFORM_DOMAIN:-platform.yourdomain.com}

---
# Ingress — routes HTTPS traffic to gateway-svc
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: seaclaw-ingress
  namespace: seaclaw-platform
  annotations:
    # ── Traefik (K3s default) ──────────────────────────────
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    # ── nginx-ingress (alternative) ───────────────────────
    # kubernetes.io/ingress.class: nginx
    # nginx.ingress.kubernetes.io/ssl-redirect: "true"
    # nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    # nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    # ── cert-manager ──────────────────────────────────────
    cert-manager.io/cluster-issuer: letsencrypt-prod
    # ── Rate limiting (nginx only) ────────────────────────
    # nginx.ingress.kubernetes.io/limit-rps: "20"
spec:
  ingressClassName: traefik   # change to 'nginx' if using nginx-ingress
  tls:
    - hosts:
        - ${PLATFORM_DOMAIN:-platform.yourdomain.com}
      secretName: seaclaw-tls-secret
  rules:
    - host: ${PLATFORM_DOMAIN:-platform.yourdomain.com}
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: gateway-svc
                port:
                  number: 8090

---
# HTTP → HTTPS redirect (Traefik middleware)
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: redirect-https
  namespace: seaclaw-platform
spec:
  redirectScheme:
    scheme: https
    permanent: true

---
# HTTP IngressRoute for redirect (Traefik only)
# Remove this section if using nginx-ingress
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: seaclaw-http-redirect
  namespace: seaclaw-platform
spec:
  entryPoints:
    - web
  routes:
    - match: Host(`${PLATFORM_DOMAIN:-platform.yourdomain.com}`)
      kind: Rule
      middlewares:
        - name: redirect-https
      services:
        - name: gateway-svc
          port: 8090
